name: Nightly-MC status collector

on:
  schedule:
    - cron: "0 12 * * *"   # run daily at 12:00 UTC
  workflow_dispatch:       # allow manual trigger

jobs:
  collect:
    runs-on: [self-hosted, cern-sso]
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python venv
        run: |
          python3 -m venv .venv
          source .venv/bin/activate
          pip install --upgrade pip
          pip install requests beautifulsoup4

      - name: Run job collectors
        run: |
          source .venv/bin/activate
          mkdir -p data
          collector_script=workflow_scripts/lpmtype_jobinfo_collector.py
          
          # Query multiple lpmtypes (example: 27506, 27507)
          python3 ${collector_script} --lpmtype 27506 --output data/jobs_27506.json
          python3 ${collector_script} --lpmtype 27507 --output data/jobs_27507.json

      - name: Merge JSONs
        run: |
          source .venv/bin/activate
          python3 workflow_scripts/lpmtype_jobinfo_merger.py data/jobs*.json --output data/merged.json

      - name: Commit and push results
        env:
          ACTIONS_BOT_TOKEN: ${{ secrets.ACTIONS_BOT_TOKEN }}
        run: |
          git config user.name "actions-bot"
          git config user.email "actions-bot@users.noreply.github.com"
          git add data/merged.json
          git commit -m "Update merged jobs.json [ci skip]" || echo "No changes to commit"
          git remote set-url origin https://x-access-token:${ACTIONS_BOT_TOKEN}@github.com/${{ github.repository }}
          git push origin HEAD:${{ github.ref }}
