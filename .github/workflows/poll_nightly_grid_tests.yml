name: Nightly-MC status collector

on:
  schedule:
    - cron: "0 12 * * *"   # run daily at 12:00 UTC
  workflow_dispatch:       # allow manual trigger

permissions:
  contents: write # allow push 

jobs:
  collect:
    runs-on: [self-hosted, cern-sso]
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python venv
        run: |
          python3 -m venv .venv
          source .venv/bin/activate
          pip install --upgrade pip
          pip install requests beautifulsoup4

      - name: Run job collectors
        run: |
          source .venv/bin/activate
          mkdir -p data
          collector_script=workflow_scripts/lpmtype_jobinfo_collector.py
          
          # Query multiple lpmtypes (example: 27506, 27507)
          python3 ${collector_script} --lpmtype 27506 --output o2sim_nightlies_status/jobs_27506.json
          python3 ${collector_script} --lpmtype 27507 --output o2sim_nightlies_status/jobs_27507.json

      # should get the merged datasets
      - name: Fetch existing branch
        run: |
          git config user.name "actions-bot"
          git config user.email "actions-bot@users.noreply.github.com"

          BRANCH="O2sim-nightly-status"
          git fetch origin $BRANCH || true
          git checkout -B $BRANCH origin/$BRANCH || git checkout -B $BRANCH
      
      - name: Merge JSONs
        run: |
          source .venv/bin/activate
          
          python3 workflow_scripts/lpmtype_jobinfo_merger.py o2sim_nightlies_status/jobs_27506.json --output o2sim_nightlies_status/merged_27506.json
          python3 workflow_scripts/lpmtype_jobinfo_merger.py o2sim_nightlies_status/jobs_27507.json --output o2sim_nightlies_status/merged_27507.json
  
          jq '' data/merged_27506.json
          jq '' data/merged_27507.json
          
      - name: Commit and push results
        run: |
          # stage and commit changes
          git add o2sim_nightlies_status/merged*.json
          git commit -m "Update nightly job status" || echo "No changes to commit"
          BRANCH="O2sim-nightly-status"
          # git push origin HEAD:${{ github.ref }}
          git push --set-upstream origin $BRANCH
